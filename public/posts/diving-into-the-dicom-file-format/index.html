<!DOCTYPE html>
















































<html
  class="not-ready lg:text-base"
  style="--bg: #faf8f1"
  lang="en"
>
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, shrink-to-fit=no"
  />

  
  <title>Diving into the DICOM file format - Voidzone</title>

  
  <meta name="theme-color" />

  
  
  
  <meta name="description" content="Introduction While doing some research about file formats, I occasionally found some references about the DICOM file format. Since I never heard about it I&rsquo;ve decided to dig deeper.
16/02/2024 Update It seems that the developer was already aware of the Double-Free issue since it has been reported a few weeks ago and it&rsquo;s ready to be merged into the main branch. The issue has been reported in the following Github issue - Double Free and Github Issue - Floating point." />
  <meta name="author" content="Cristian &#39;void&#39; Giustini" />
  

  
  
  
  
  
  
  <link rel="preload stylesheet" as="style" href="https://voidzone.me/main.min.css" />

  
  <script
    defer
    src="https://voidzone.me/highlight.min.js"
    onload="hljs.initHighlightingOnLoad();"
  ></script>
  

  
   
  <link rel="preload" as="image" href="https://voidzone.me/theme.png" />

  
  
  
  <link rel="preload" as="image" href="https://www.gravatar.com/avatar/d4f904f245c1fd17d7f8fc7b662b7076?s=160&amp;d=identicon" />
  
  

  
  <link rel="preload" as="image" href="https://voidzone.me/twitter.svg" />
  
  <link rel="preload" as="image" href="https://voidzone.me/github.svg" />
  
  <link rel="preload" as="image" href="https://voidzone.me/linkedin.svg" />
  
  <link rel="preload" as="image" href="https://voidzone.me/mastodon.svg" />
  
  <link rel="preload" as="image" href="https://voidzone.me/steam.svg" />
  
  

  
  

  
  <link rel="icon" href="https://voidzone.me/favicon.ico" />
  <link rel="apple-touch-icon" href="https://voidzone.me/apple-touch-icon.png" />

  
  <meta name="generator" content="Hugo 0.115.4">

  
  

  
  
  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-Z425PXG6E5', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  
  
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Z425PXG6E5"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-Z425PXG6E5', { 'anonymize_ip': false });
}
</script>

  
  <meta property="og:title" content="Diving into the DICOM file format" />
<meta property="og:description" content="Introduction While doing some research about file formats, I occasionally found some references about the DICOM file format. Since I never heard about it I&rsquo;ve decided to dig deeper.
16/02/2024 Update It seems that the developer was already aware of the Double-Free issue since it has been reported a few weeks ago and it&rsquo;s ready to be merged into the main branch. The issue has been reported in the following Github issue - Double Free and Github Issue - Floating point." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://voidzone.me/posts/diving-into-the-dicom-file-format/" /><meta property="og:image" content="https://voidzone.me/logo/void.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-02-06T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-02-06T00:00:00+00:00" />

  
  <meta itemprop="name" content="Diving into the DICOM file format">
<meta itemprop="description" content="Introduction While doing some research about file formats, I occasionally found some references about the DICOM file format. Since I never heard about it I&rsquo;ve decided to dig deeper.
16/02/2024 Update It seems that the developer was already aware of the Double-Free issue since it has been reported a few weeks ago and it&rsquo;s ready to be merged into the main branch. The issue has been reported in the following Github issue - Double Free and Github Issue - Floating point."><meta itemprop="datePublished" content="2024-02-06T00:00:00+00:00" />
<meta itemprop="dateModified" content="2024-02-06T00:00:00+00:00" />
<meta itemprop="wordCount" content="2021"><meta itemprop="image" content="https://voidzone.me/logo/void.png">
<meta itemprop="keywords" content="" />
  
  <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://voidzone.me/logo/void.png"/>

<meta name="twitter:title" content="Diving into the DICOM file format"/>
<meta name="twitter:description" content="Introduction While doing some research about file formats, I occasionally found some references about the DICOM file format. Since I never heard about it I&rsquo;ve decided to dig deeper.
16/02/2024 Update It seems that the developer was already aware of the Double-Free issue since it has been reported a few weeks ago and it&rsquo;s ready to be merged into the main branch. The issue has been reported in the following Github issue - Double Free and Github Issue - Floating point."/>

  
  
</head>

  <body class="text-black duration-200 ease-out dark:text-white">
    <header class="mx-auto flex h-[4.5rem] max-w-3xl px-8 lg:justify-center">
  <div class="relative z-50 mr-auto flex items-center">
    <a
      class="-translate-x-[1px] -translate-y-[1px] text-2xl font-semibold"
      href="https://voidzone.me/"
      >Voidzone</a
    >
    <div
      class="btn-dark text-[0] ml-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]"
      role="button"
      aria-label="Dark"
    ></div>
  </div>

  <div
    class="btn-menu relative z-50 -mr-8 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden"
    role="button"
    aria-label="Menu"
  ></div>

  
  <script>
    
    const htmlClass = document.documentElement.classList;
    setTimeout(() => {
      htmlClass.remove('not-ready');
    }, 10);

    
    const btnMenu = document.querySelector('.btn-menu');
    btnMenu.addEventListener('click', () => {
      htmlClass.toggle('open');
    });

    
    const metaTheme = document.querySelector('meta[name="theme-color"]');
    const lightBg = '#faf8f1'.replace(/"/g, '');
    const setDark = (isDark) => {
      metaTheme.setAttribute('content', isDark ? '#000' : lightBg);
      htmlClass[isDark ? 'add' : 'remove']('dark');
      localStorage.setItem('dark', isDark);
    };

    
    const darkScheme = window.matchMedia('(prefers-color-scheme: dark)');
    if (htmlClass.contains('dark')) {
      setDark(true);
    } else {
      const darkVal = localStorage.getItem('dark');
      setDark(darkVal ? darkVal === 'true' : darkScheme.matches);
    }

    
    darkScheme.addEventListener('change', (event) => {
      setDark(event.matches);
    });

    
    const btnDark = document.querySelector('.btn-dark');
    btnDark.addEventListener('click', () => {
      setDark(localStorage.getItem('dark') !== 'true');
    });
  </script>

  <div
    class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"
  >
    
    
    <nav class="lg:ml-12 lg:flex lg:flex-row lg:items-center lg:space-x-6">
      
      <a
        class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal"
        href="/about/"
        >About</a
      >
      
    </nav>
    

    
    <nav
      class="mt-12 flex justify-center space-x-10 dark:invert lg:ml-12 lg:mt-0 lg:items-center lg:space-x-6"
    >
      
      <a
        class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./twitter.svg)"
        href="https://twitter.com/voidz0r"
        target="_blank"
        rel="me"
      >
        twitter
      </a>
      
      <a
        class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./github.svg)"
        href="https://github.com/voidz0r"
        target="_blank"
        rel="me"
      >
        github
      </a>
      
      <a
        class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./linkedin.svg)"
        href="https://linkedin.com/in/voidde"
        target="_blank"
        rel="me"
      >
        linkedin
      </a>
      
      <a
        class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./mastodon.svg)"
        href="https://infosec.exchange/@voidde"
        target="_blank"
        rel="me"
      >
        mastodon
      </a>
      
      <a
        class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./steam.svg)"
        href="https://steamcommunity.com/id/retvoid"
        target="_blank"
        rel="me"
      >
        steam
      </a>
      
    </nav>
    
  </div>
</header>


    <main
      class="prose prose-neutral relative mx-auto min-h-[calc(100%-9rem)] max-w-3xl px-8 pb-16 pt-12 dark:prose-invert"
    >
      

<article>
  <header class="mb-16">
    <h1 class="!my-0 pb-2.5">Diving into the DICOM file format</h1>

    
    <div class="text-sm antialiased opacity-60">
      
      <time>Feb 6, 2024</time>
      
      
      
      
    </div>
    
  </header>

  <section><h2 id="introduction">Introduction</h2>
<p>While doing some research about file formats, I occasionally found some references about the DICOM file format. Since I never heard about it I&rsquo;ve decided to dig deeper.</p>
<h3 id="16022024-update">16/02/2024 Update</h3>
<p>It seems that the developer was already aware of the Double-Free issue since it has been reported a few weeks ago and it&rsquo;s ready to be merged into the main branch. The issue has been reported in the following <a href="https://github.com/ImagingDataCommons/libdicom/issues/82">Github issue - Double Free</a> and <a href="https://github.com/ImagingDataCommons/libdicom/issues/83">Github Issue - Floating point</a>.</p>
<h2 id="the-format">The format</h2>
<p>DICOM, acronym for Digital Imaging and Communications in Medicine, is both a communication protocol and a file format. As the name suggests, the format is widely used by a series of medical devices such as radiography, magnetic resonance imaging and radiation therapy. The protocol itself has been release in 1985 by American College of Radiology (ACR) and National Electrical Manufacturers Association (NEMA). The communication part of the protocol was already covered by Sina Yazdanmehr during Black Hat 2023. Following the link to <a href="https://i.blackhat.com/EU-23/Presentations/EU-23-Yazdanmehr-Millions_of_Patient_Records_at_Risk.pdf">his research</a></p>
<p>The main principle behind the format is to group information into data sets and each dataset will represent the data about the patient such as his ID, first name and last name, and associated image(s). The file format also acts like an encapsulator since it supports several other standards such as JPEG, GIF, PNG and so on.</p>
<p>A typical DICOM file would look like the following:</p>
<pre tabindex="0"><code>   Free text          Magic number
┌──────────────┬──────────────────────┬─────────────────────┐
│              │                      │                     │
│    header    │   \x44\x49\x43\x4d   │    data elements    │
│              │        &#34;DICM&#34;        │                     │
│              │                      │                     │
│              │                      │                     │
│  1024 bits   │       4 bytes        │                     │
└──────────────┴──────────────────────┴─────────────────────┘
</code></pre><p>Each subsequent data element will have a Value Representation, which can be expressed as &ldquo;Implicit&rdquo; or &ldquo;Explicit&rdquo;, depending if the specific VR is supplied or not. Explicit VR needs to be represented differently depending on the supplied VR value.</p>
<pre tabindex="0"><code>Data Element with explicit VR of AE, AS, AT, CS, DA, DS, DT, FL, FD, IS, LO, LT, PN, SH, SL, SS, ST, TM, UI, UL and US
┌────────────────────────────────────┬──────────────────────┬────────────────┬─────────────────┐
│               TAG                  │         VR           │   Value length │      Value      │
├─────────────────┬──────────────────┼──────────────────────┼────────────────┼─────────────────┤
│   group number  │  element number  │         VR           │     Length     │ Even number of  │
│                 │                  │ Value Representation │                │ bytes encoded   │
│                 │                  │                      │                │ according to VR │
│     16 bits     │      16 bits     │       16 bits        │                │                 │
│   unsigned int  │   unsigned int   │   2 byte character   │     16 bits    │                 │
└─────────────────┴──────────────────┴──────────────────────┴────────────────┴─────────────────┘
</code></pre><p>When a different VR from the previous ones is used, the Data element needs to be provided as following:</p>
<pre tabindex="0"><code>Data Element with explicit VR other than the previous ones
┌────────────────────────────────────┬───────────────────────────────────┬─────────────────┬──────────────────┐
│               TAG                  │                VR                 │   Value length  │       Value      │
├─────────────────┬──────────────────┼─────────────────────┬─────────────┼─────────────────┼──────────────────┤
│   group number  │  element number  │         VR          │  Reserved   │      Length     │ Even number of   │
│                 │                  │ Value Representation│             │                 │ bytes encoded    │
│                 │                  │                     │             │                 │ according to VR  │
│     16 bits     │      16 bits     │       16 bits       │             │                 │                  │
│   unsigned int  │   unsigned int   │   2 byte character  │  16 bits    │     32 bits     │                  │
└─────────────────┴──────────────────┴─────────────────────┴─────────────┴─────────────────┴──────────────────┘
</code></pre><p>While implicit Data Elements are represented as follow:</p>
<pre tabindex="0"><code>Implicit Data Element
┌────────────────────────────────────┬────────────────┬───────────────────┐
│               TAG                  │  Value length  │       Value       │
├─────────────────┬──────────────────┼────────────────┼───────────────────┤
│   group number  │  element number  │    Length      │  Even number of   │
│                 │                  │                │  bytes encoded    │
│                 │                  │                │  according to VR  │
│     16 bits     │      16 bits     │                │                   │
│   unsigned int  │   unsigned int   │   32 bits      │                   │
└─────────────────┴──────────────────┴────────────────┴───────────────────┘
</code></pre><p>Each VR will represent a different type of data like, for instance:</p>
<ul>
<li>AE - max 16 bytes - Application Entity</li>
<li>AS - 4 bytes - Age string</li>
<li>AT - 4 bytes - Attribute</li>
<li>DA - 8 bytes - The date expressed as YYYYMMDD like for example: 20240207</li>
</ul>
<p>And so on. All the VRs can be found in the official <a href="https://dicom.nema.org/medical/dicom/current/output/html/part05.html#table_6.2-1">DICOM Standard</a> documentation.</p>
<p>Here is a valid DICOM file viewed with the <code>xxd</code> tool:</p>
<p><img src="/dicom/01_xxd.png" alt="DICOM file"></p>
<h2 id="fuzzing-the-libdicom-library">Fuzzing the libdicom library</h2>
<p>One of the many libraries that parse .dcm files is the <code>libdicom</code> library, which can be found on <a href="https://github.com/ImagingDataCommons/libdicom">Github</a>.</p>
<p>While the library uses the <code>meson</code> tool in order to build the project, AFL doesn&rsquo;t seems to be compatible with it. I converted the .ninja files using a tool called <code>ninjatool</code> which generates a Makefile from a ninja one. It is availabe on Github as well <a href="https://github.com/bonzini/qemu/blob/meson-poc/scripts/ninjatool.py">ninjatool.py</a>.</p>
<p>In order to fuzz the library we need an entry point for the fuzzer, which takes an input file (or stdin) and pass it to the libdicom library. The example on the official github page can be used:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;dicom/dicom.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;dicom/dicom.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[]) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>file_path <span style="color:#f92672">=</span> argv[<span style="color:#ae81ff">1</span>]; <span style="color:#75715e">// We change this value to argv[1] so it can accept a filename on stdin
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    DcmError <span style="color:#f92672">*</span>error <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    DcmFilehandle <span style="color:#f92672">*</span>filehandle <span style="color:#f92672">=</span> <span style="color:#a6e22e">dcm_filehandle_create_from_file</span>(<span style="color:#f92672">&amp;</span>error, file_path);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (filehandle <span style="color:#f92672">==</span> NULL) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">dcm_error_log</span>(error);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">dcm_error_clear</span>(<span style="color:#f92672">&amp;</span>error);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> DcmDataSet <span style="color:#f92672">*</span>metadata <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">dcm_filehandle_get_metadata_subset</span>(<span style="color:#f92672">&amp;</span>error, filehandle);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (metadata <span style="color:#f92672">==</span> NULL) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">dcm_error_log</span>(error);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">dcm_error_clear</span>(<span style="color:#f92672">&amp;</span>error);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">dcm_filehandle_destroy</span>(filehandle);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>num_frames;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint32_t</span> tag <span style="color:#f92672">=</span> <span style="color:#a6e22e">dcm_dict_tag_from_keyword</span>(<span style="color:#e6db74">&#34;NumberOfFrames&#34;</span>);
</span></span><span style="display:flex;"><span>    DcmElement <span style="color:#f92672">*</span>element <span style="color:#f92672">=</span> <span style="color:#a6e22e">dcm_dataset_get</span>(<span style="color:#f92672">&amp;</span>error, metadata, tag);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (element <span style="color:#f92672">==</span> NULL <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">!</span><span style="color:#a6e22e">dcm_element_get_value_string</span>(<span style="color:#f92672">&amp;</span>error, element, <span style="color:#ae81ff">0</span>, <span style="color:#f92672">&amp;</span>num_frames)) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">dcm_error_log</span>(error);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">dcm_error_clear</span>(<span style="color:#f92672">&amp;</span>error);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">dcm_filehandle_destroy</span>(filehandle);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;NumerOfFrames == %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, num_frames);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">dcm_filehandle_destroy</span>(filehandle);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>After loading some .DCM files that I found on Google, I was happy to see that a lot of crashes showed up on AFL.</p>
<h2 id="crash-1---floating-point-exception">Crash 1 - Floating point exception</h2>
<p>The first crash was regarding a floating point exception and it&rsquo;s regarding the <code>get_tiles</code> function of the <code>dicom-file.c</code> file.</p>
<p>Analyzing via GDB shows the following:</p>
<p><img src="/dicom/fp1/02_floating_point_exception.png" alt="Floating Point Exception"></p>
<p>And the corresponding function is:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">get_tiles</span>(DcmError <span style="color:#f92672">**</span>error,
</span></span><span style="display:flex;"><span>                      <span style="color:#66d9ef">const</span> DcmDataSet <span style="color:#f92672">*</span>metadata,
</span></span><span style="display:flex;"><span>                      <span style="color:#66d9ef">uint32_t</span> <span style="color:#f92672">*</span>tiles_across,
</span></span><span style="display:flex;"><span>                      <span style="color:#66d9ef">uint32_t</span> <span style="color:#f92672">*</span>tiles_down)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int64_t</span> width;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int64_t</span> height;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint32_t</span> frame_width;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint32_t</span> frame_height;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">get_frame_size</span>(error, metadata, <span style="color:#f92672">&amp;</span>frame_width, <span style="color:#f92672">&amp;</span>frame_height)) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// TotalPixelMatrixColumns is optional and defaults to Columns, ie. one
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// frame across
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    width <span style="color:#f92672">=</span> frame_width;
</span></span><span style="display:flex;"><span>    (<span style="color:#66d9ef">void</span>) <span style="color:#a6e22e">get_tag_int</span>(NULL, metadata, <span style="color:#e6db74">&#34;TotalPixelMatrixColumns&#34;</span>, <span style="color:#f92672">&amp;</span>width); <span style="color:#75715e">// &lt;--- crash here
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// TotalPixelMatrixColumns is optional and defaults to Columns, ie. one
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// frame across
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    height <span style="color:#f92672">=</span> frame_width;
</span></span><span style="display:flex;"><span>    (<span style="color:#66d9ef">void</span>) <span style="color:#a6e22e">get_tag_int</span>(NULL, metadata, <span style="color:#e6db74">&#34;TotalPixelMatrixRows&#34;</span>, <span style="color:#f92672">&amp;</span>height);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>tiles_across <span style="color:#f92672">=</span> (<span style="color:#66d9ef">uint32_t</span>) width <span style="color:#f92672">/</span> frame_width <span style="color:#f92672">+</span> <span style="color:#f92672">!!</span>(width <span style="color:#f92672">%</span> frame_width);
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>tiles_down <span style="color:#f92672">=</span> (<span style="color:#66d9ef">uint32_t</span>) height <span style="color:#f92672">/</span> frame_height <span style="color:#f92672">+</span> <span style="color:#f92672">!!</span>(height <span style="color:#f92672">%</span> frame_height);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> true;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Putting a breakpoint on line <code>152</code> shows that width and height are actually zero, so the exception is because the value pointed by <code>tiles_across</code> is dividing zero by zero.</p>
<p><img src="/dicom/fp1/03_breakpoint.png" alt="GDB Breakpoint"></p>
<p>The width and height comes from the call to the function <code>get_frame_size</code> which takes the reference to <code>uint32_t frame_width</code> and <code>uint32_t frame_height</code> as parameters.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">get_tag_int</span>(error, metadata, <span style="color:#e6db74">&#34;Columns&#34;</span>, <span style="color:#f92672">&amp;</span>width) <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">!</span><span style="color:#a6e22e">get_tag_int</span>(error, metadata, <span style="color:#e6db74">&#34;Rows&#34;</span>, <span style="color:#f92672">&amp;</span>height)) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>frame_width <span style="color:#f92672">=</span> (<span style="color:#66d9ef">uint32_t</span>) width;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>frame_height <span style="color:#f92672">=</span> (<span style="color:#66d9ef">uint32_t</span>) height;
</span></span></code></pre></div><p>But where the &ldquo;Columns&rdquo; and &ldquo;Rows&rdquo; comes from? They can be found on the <code>dicom-dict-tables.c</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> _DcmAttribute dcm_attribute_table[] <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    {<span style="color:#ae81ff">0</span>X00280010, DCM_VR_TAG_US, <span style="color:#e6db74">&#34;Rows&#34;</span>},
</span></span><span style="display:flex;"><span>    {<span style="color:#ae81ff">0</span>X00280011, DCM_VR_TAG_US, <span style="color:#e6db74">&#34;Columns&#34;</span>},
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p>And if we search for the tag value on the payload (little endian order), we should see a <code>2800 1000</code> for Rows and <code>2800 1100</code> for Columns.</p>
<p><img src="/dicom/fp1/04_hex.png" alt="Input file"></p>
<p>So in this case the &ldquo;Columns&rdquo; tag value is used to determine the <code>frame_width</code> and calculate the number of tiles across, leading to the floating point exception.</p>
<p>Note: this bug is also valid for the tag <code>2800 1000</code> or Rows/Height.</p>
<h2 id="crash-2---double-free-on-data-set-headers">Crash 2 - Double free on Data set headers</h2>
<p>This one looked way more interesting from an exploitation point of view.</p>
<p><img src="/dicom/dfree/05_segfault.png" alt="Segfault"></p>
<p>By looking at the debug messages, which can be activated by using the <code>DCM_DEBUG=1</code> env variable, it is obvious that the library tried to <code>free</code> a specific value twice, first on tag <code>0200 3030</code> and then on some address on the heap.</p>
<p>Inspecting the crash with gdb shows:</p>
<p><img src="/dicom/dfree/07_gdb_rootcause.png" alt="Inspect with GDB"></p>
<p>So the library, for some reason, calls the <code>dcm_element_destroy</code> function twice. By putting a breakpoint we see:</p>
<p><img src="/dicom/dfree/08_first_break.png" alt="Break #1">
<img src="/dicom/dfree/09_second_break.png" alt="Break #2"></p>
<p>A look at the source code shows this:</p>
<p><img src="/dicom/dfree/10_firstfree.png" alt="First free">
<img src="/dicom/dfree/11_secondfree.png" alt="Second free"></p>
<p>So this means that whenever there are duplicated tags into the the DCM body, the <code>dcm_dataset_insert</code> fails, <code>free</code> the element and returns false. In the <code>parse_meta_element_create</code> there will be another <code>free</code> because of that boolean result, which is causing the double free. But what the message <code>free(): double free detected in tcache 2</code> means?</p>
<p>The message shows that the glibc protection against double free got triggered and prevented to double free the memory chunk. The tcache is a heap caching mechanism introduced from the glibc 2.26 back in 2017 and it offers some performance gains by creating per-thread caches for chunks up to a certain size. This means that it will first look into the tcache bins before traversing small, fast, large or unsorted bins, whenever a chunk is allocated or freed.</p>
<h2 id="crash-3---double-free-on-the-data-set-body">Crash 3 - Double free on the Data set body</h2>
<p>Almost in the same way as above, it is possible to achieve a double free by putting another element with the same tag in the body.</p>
<p><img src="/dicom/dfree_body/01_crash_gdb.png" alt="Crash 1"></p>
<p>And the root cause</p>
<p><img src="/dicom/dfree_body/02_debug.png" alt="Crash 2"></p>
<h2 id="crash-4---double-free-on-sequence-elements">Crash 4 - Double free on sequence elements</h2>
<p>As specified in the documentation, DICOM format supports sequences which is a way to append multiple items into a list to achieve a nested data set.</p>
<p>By looking at the following crash:</p>
<p><img src="/dicom/dfree_sequences/01_crash.png" alt="Crash - Sequences"></p>
<p>And putting some breakpoints:</p>
<p><img src="/dicom/dfree_sequences/02_first_free.png" alt="Crash - Sequences - Breakpoint hit #1"></p>
<p><img src="/dicom/dfree_sequences/03_second_free.png" alt="Crash - Sequences - Breakpoint hit #2"></p>
<p>We can clearly see that data is hitting the <code>dcm_dataset_insert</code> first before beying free&rsquo;d on the <code>dcm_sequence_destroy</code> function. Subsequentially, another <code>dcm_sequence_destroy</code> is getting triggered, this time from the <code>parse_meta_sequence_end</code> function.</p>
<p>If we follow the functions in the source code we see:</p>
<p><img src="/dicom/dfree_sequences/05_rootcause_firstfree.png" alt="Crash - Sequences - Root cause #2"></p>
<p><img src="/dicom/dfree_sequences/04_rootcause.png" alt="Crash - Sequences - Root cause #1"></p>
<p>If we look at the screenshots above we can understand why this is happening:</p>
<ul>
<li>The dataset is first parsed by the <code>dcm_dataset_insert</code> function which is responsible for parsing the dataset. If a tag name is already in the dataset, it fails with a message and <code>free</code> the element from memory</li>
<li>The dataset is then parsed by the <code>parse_meta_sequence_end</code> function which calls another <code>free</code>, but this time the pointer to the heap has been free&rsquo;d already by the previous function, so the pointer points to another memory area.</li>
</ul>
<p>Until now we used what AFL generated from the input files, but how we can control each element and build our own DCM file?</p>
<h2 id="dcm-builder-in-the-building">DCM Builder in the building!</h2>
<p>While there are some libraries that parse .dcm files, like <code>pydicom</code>, I had the necessity for a tool that builds arbitrary data elements and force the library to load sequence of data in a specific order. So I&rsquo;ve built the <code>dicombuilder</code> library.</p>
<p>The library is pretty simple, it uses a dictionary of all the possible values, declared in the <code>dicttable.py</code> file like the following:</p>
<p><img src="/dicom/dicom_builder/01_dicttable.png" alt="Dicombuilder dicttable"></p>
<p>Along with some helper functions like <code>find_by_hex</code> or <code>find_by_name</code> to look for a specific element using the name, instead of the hex value. In the end, I was able to build a dicom file in the following way:</p>
<p><img src="/dicom/dicom_builder/02_building_dicomfile.png" alt="Building a DICOM file"></p>
<p>I will upload the package to PyPi and you can install the package via <code>pip install -e dicombuilder .</code> after cloning it from <a href="https://github.com/voidz0r/dicombuilder">Github</a></p>
<h2 id="impact">Impact</h2>
<p>Controlling the flow of execution in this case will be pretty hard, because of the amount of memory mitigations in place. By the time of writing this, I was using glibc 2.35. Here are some techniques that are available:</p>
<ul>
<li>decrypt_safe_linking</li>
<li>fastbin_dup</li>
<li>fastbin_dup_consolidate</li>
<li>fastbin_reverse_into_tcache</li>
<li>house_of_botcake</li>
<li>house_of_einherjar</li>
<li>house_of_lore</li>
<li>house_of_mind_fastbin</li>
<li>house_of_spirit</li>
<li>house_of_water</li>
<li>large_bin_attack</li>
<li>mmap_overlapping_chunks</li>
<li>overlapping_chunks</li>
<li>poison_null_byte</li>
<li>safe_link_double_protect</li>
<li>tcache_house_of_spirit</li>
<li>tcache_poisoning</li>
<li>tcache_stashing_unlink_attack</li>
<li>unsafe_unlink</li>
</ul>
<p>All the above methodologies require to have a precise control about what needs to be free&rsquo;d and in which order. Giving our scenario:</p>
<ul>
<li>We don&rsquo;t have control on the size. The majority of the allocations are handled in a precise way and even if we force a specific length, there are some additional checks made on each VR and pre-defined sizes</li>
<li>We don&rsquo;t have control of the <code>free</code>/<code>malloc</code> order. The application parse the entire file in a top-down flow, starting from allocating memory regions while reading the data elements to free the memory at the end. With this in mind it&rsquo;s trivial, if not impossible, to force a specific <code>free</code> and <code>malloc</code> sequence.</li>
</ul>
<p>So the result will be just a crash.</p>
<h1 id="related-impact">Related impact</h1>
<p>Some projects such as &ldquo;openslide&rdquo; uses libdicom library to parse .dcm files. As a result, even with programs like QuPath, the application crashes with the following error:</p>
<p><img src="/dicom/qupath.png" alt="QuPath Crash"></p>
<p>Which is a heap corruption error:</p>
<p><img src="/dicom/qupath_error.png" alt="QuPath Windows error code"></p>
</section>

  
  

  
  
  
  <nav class="mt-24 flex rounded-lg bg-black/[3%] text-lg dark:bg-white/[8%]">
    
    <a
      class="flex w-1/2 items-center rounded-l-md p-6 pr-3 font-semibold no-underline hover:bg-black/[2%] dark:hover:bg-white/[3%]"
      href="https://voidzone.me/posts/a-phishing-attempt-on-steam-that-became-qrljacking/"
      ><span class="mr-1.5">←</span><span>A phishing attempt on Steam that became a Qrljacking research</span></a
    >
    
    
    <a
      class="ml-auto flex w-1/2 items-center justify-end rounded-r-md p-6 pl-3 font-semibold no-underline hover:bg-black/[2%] dark:hover:bg-white/[3%]"
      href="https://voidzone.me/posts/cve-2022-44268-imagemagick-arbitrary-file-read/"
      ><span>CVE-2022-44268 - Proof Of Concept of the ImageMagick Arbitrary File Read vulnerability</span><span class="ml-1.5">→</span></a
    >
    
  </nav>
  

  
  

  
  
</article>


    </main>

    <footer
  class="opaco mx-auto flex h-[4.5rem] max-w-3xl items-center px-8 text-[0.9em] opacity-60"
>
  <div class="mr-auto">
    &copy; 2024
    <a class="link" href="https://voidzone.me/">Voidzone</a>
  </div>
  <a class="link mx-6" href="https://gohugo.io/" rel="noopener" target="_blank"
    >Powered by Hugo️️</a
  >️
  <a
    class="link"
    href="https://github.com/nanxiaobei/hugo-paper"
    rel="noopener"
    target="_blank"
    >✎ Paper</a
  >
</footer>

  </body>
</html>
